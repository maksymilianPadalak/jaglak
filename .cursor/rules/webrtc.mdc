---
description: WebRTC and WebSocket patterns
globs: ["**/server/**", "**/web/**"]
alwaysApply: false
---

# WebRTC Patterns

## Signaling Protocol

- Use raw WebSocket (not Socket.io) for signaling
- All messages are JSON formatted
- Message types defined in `@jaglak/shared-types`

## Message Flow

1. Client connects via WebSocket
2. Server sends `connected` message with socketId
3. Client sends `join-room` message
4. Server responds with `existing-users` or `user-joined`
5. Peers exchange `offer`, `answer`, and `ice-candidate` messages
6. Once connected, video streams peer-to-peer (bypasses server)

## WebSocket Connection

```typescript
// Client-side WebSocket connection
const WS_URL = process.env.NEXT_PUBLIC_WS_URL || 'ws://localhost:3000';
const ws = new WebSocket(WS_URL);

ws.onmessage = (event) => {
  const data = JSON.parse(event.data) as ServerMessage;
  handleServerMessage(data);
};
```

## WebRTC Peer Connection

- Always use STUN servers: `stun:stun.l.google.com:19302`
- Create RTCPeerConnection with configuration object
- Add local tracks before creating offer
- Handle `ontrack` event for remote streams
- Send ICE candidates through signaling server

## Error Handling

- Always wrap WebRTC operations in try-catch
- Handle connection state changes
- Clean up peer connections on disconnect
- Log errors but don't expose sensitive info to client

## Room Management

- Rooms are identified by string IDs
- Server maintains room membership
- Peers in same room automatically connect
- Server forwards signaling messages between peers in same room
